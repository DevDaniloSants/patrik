<!-- /snippets/collection-filters-sidebar.liquid -->
{% comment %}
  The collection sidebar containing tag filering and link-based navigation

  * collection {object} - The current collection
  * section {object} - The current section

  {% render 'collection-filters-sidebar', section: section, collection: collection %}
{% endcomment %}

{%- liquid
  assign excluded_collections_strict = settings.exclude_collections_strict | split: ','
  assign excluded_collections = settings.exclude_collections_contain | split: ','
-%}

{%- for block in section.blocks -%}

  {%- liquid
    assign accordion_initial_state = 'accordion-is-open'
    assign accordion_open_boolean = true
    if section.settings.collapse_filters
      # no class means the accordion is closed
      assign accordion_initial_state = ''
      # accordion_open_boolean is used to set aria-expanded and
      # match js logic for 'display: none' on accordion body elements
      # which are non-adjacent siblings that cannot easily be styled with CSS
      assign accordion_open_boolean = false
    endif
  -%}

  {%- case block.type -%}

  {%- when 'filters' -%}
    <!-- Desktop View (Original Accordions) -->
    <div class="hidden md:block">
      <form data-sidebar-filter-form>
        {% if collection.current_type %}
          <input type="hidden" name="q" value="{{ collection.current_type }}">
        {% endif %}
        {% if collection.current_vendor %}
          <input type="hidden" name="q" value="{{ collection.current_vendor }}">
        {% endif %}

        {%- for filter in collection.filters -%}
          {% render 'filters',
            section: section,
            block: block,
            filter: filter,
            forloop: forloop,
            accordion_open_boolean: accordion_open_boolean,
            accordion_initial_state: accordion_initial_state
          %}
        {%- endfor -%}

        <input type="submit" value="{{ 'collections.sidebar.filter' | t }}" class="btn btn--full no-js">
      </form>
    </div>

    <!-- Mobile View (Accordion Style) -->
    <div class="md:hidden mobile-filter-accordion relative overflow-y-auto h-full min-h-[50vh]">
      <style>
        .mobile-filter-accordion a span,
        .mobile-filter-accordion button span {
          font-weight: 700 !important;
        }
      </style>
      
      <ul class="flex flex-col gap-y-3">
        <!-- Categorias (Collections) -->
        <li class="border-b border-gray-100">
          <button type="button" 
            class="w-full flex justify-between items-center py-6 px-5 text-left text-3xl font-black text-gray-900 bg-white hover:bg-gray-50 uppercase tracking-widest"
            data-accordion-toggle="mobile-cat-dropdown">
            <span class="underline underline-offset-4" style="font-weight: 900; font-size: 18px;">Categorias</span>
            <span class="icon-plus font-bold" style="font-weight: 900; stroke-width: 3;">{% render 'icon-core-plus' %}</span>
            <span class="icon-minus hidden font-bold" style="font-weight: 900; stroke-width: 3;">{% render 'icon-core-minus' %}</span>
          </button>
          
          <div id="mobile-cat-dropdown" class="hidden bg-white border-t border-gray-100">
            <ul class="flex flex-col pl-4">
              {%- for collection_link in collections -%}
                {% unless collection_link.handle == 'frontpage' %}
                  <li class="border-b border-gray-200 last:border-0">
                    <a href="{{ collection_link.url }}" class="block py-4 pr-4 ml-4 text-base font-bold text-gray-700 hover:text-black hover:bg-gray-50 flex justify-between items-center decoration-0">
                      <span style="font-weight: 700; font-size: 16px;">{{ collection_link.title }}</span>
                    </a>
                  </li>
                {% endunless %}
              {%- endfor -%}
            </ul>
          </div>
        </li>

        <!-- Filters (Dynamic) -->
        {%- for filter in collection.filters -%}
          {%- assign label_downcase = filter.label | downcase -%}
          
          {%- comment -%} Skip Price and Product Type (handled by Categorias logic) {%- endcomment -%}
          {%- unless filter.type == 'price_range' or label_downcase == 'product type' or label_downcase == 'tipo de produto' -%}
            
            {%- assign display_label = filter.label -%}
            {%- if label_downcase contains 'material' or label_downcase contains 'metal' -%}
              {%- assign display_label = 'Material' -%}
            {%- elsif label_downcase contains 'pedra' or label_downcase contains 'stone' or label_downcase contains 'gem' -%}
              {%- assign display_label = 'Pedra' -%}
            {%- endif -%}

            <li class="border-b border-gray-100">
              <button type="button" 
                class="w-full flex justify-between items-center py-6 px-5 text-left text-3xl font-black text-gray-900 bg-white hover:bg-gray-50 uppercase tracking-widest"
                data-accordion-toggle="mobile-filter-{{ filter.label | handle }}">
                <span class="underline underline-offset-4" style="font-weight: 900; font-size: 18px;">{{ display_label }}</span>
                <span class="icon-plus font-bold" style="font-weight: 900; stroke-width: 3;">{% render 'icon-core-plus' %}</span>
                <span class="icon-minus hidden font-bold" style="font-weight: 900; stroke-width: 3;">{% render 'icon-core-minus' %}</span>
              </button>

              <div id="mobile-filter-{{ filter.label | handle }}" class="hidden bg-white border-t border-gray-100">
                <ul class="flex flex-col pl-4">
                  {%- for value in filter.values -%}
                    <li class="border-b border-gray-200 last:border-0">
                      <a href="{{ value.url_to_add }}" class="block py-4 pr-4 ml-4 text-base font-bold text-gray-700 hover:text-black hover:bg-gray-50 flex justify-between items-center decoration-0">
                        <span style="font-weight: 700; font-size: 16px;">{{ value.label }}</span>
                        {%- if value.active -%}
                          {% render 'icon-core-checkmark' %}
                        {%- endif -%}
                      </a>
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            </li>
          {%- endunless -%}
        {%- endfor -%}
      </ul>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var triggers = document.querySelectorAll('[data-accordion-toggle]');
          triggers.forEach(function(btn) {
            btn.addEventListener('click', function() {
              var targetId = this.getAttribute('data-accordion-toggle');
              var content = document.getElementById(targetId);
              var plus = this.querySelector('.icon-plus');
              var minus = this.querySelector('.icon-minus');

              if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                plus.classList.add('hidden');
                minus.classList.remove('hidden');
              } else {
                content.classList.add('hidden');
                plus.classList.remove('hidden');
                minus.classList.add('hidden');
              }
            });
          });
        });
      </script>
    </div>

  {%- when 'nav_links' -%}
    {% unless block.settings.collection_linklist == blank or block.settings.collection_linklist.empty? %}
      {% assign custom_nav_list = block.settings.collection_linklist | handleize %}

      {%- capture links_html -%}
        {% for link in linklists[custom_nav_list].links %}
          {% if link.links == blank %}
            <div class="sidebar__item{% if link.active %} sidebar__item--active{% endif %} stateful-filter-icons{% if forloop.index > 10 %} is-hidden{% endif %}">
              <a href="{{ link.url }}">{{ link.title }}</a>
              {% render 'icon-stateful-box' %}
            </div>

            {%- if link.active -%}
              {%- assign accordion_initial_state = 'accordion-is-open' -%}
              {%- assign accordion_open_boolean = true -%}
            {%- endif -%}
          {% endif %}
        {% endfor %}
      {%- endcapture -%}

      <div class="sidebar__filter__group" {{ block.shopify_attributes }}>
        <button class="sidebar__heading js {{ accordion_initial_state }}"
          data-accordion-trigger="accordion-{{ block.id }}"
          aria-controls="accordion-{{ block.id }}"
          aria-haspopup="true"
          aria-expanded="{{ accordion_open_boolean }}">

          <span>{{ linklists[custom_nav_list].title }}</span>

          <span class="sidebar__heading-chevron">
            {% render 'icon-core-chevron-right' %}
            <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
            <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
          </span>
        </button>

        <input type="checkbox"
          name="accordion-{{ block.id }}"
          id="accordion-{{ block.id }}-checkbox"
          class="no-js no-js-checkbox" checked>

        <label for="accordion-{{ block.id }}-checkbox" class="sidebar__heading no-js">
          <span>{{ linklists[custom_nav_list].title }}</span>

          <span class="sidebar__heading-chevron">
            {% render 'icon-core-chevron-right' %}
            <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
            <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
          </span>
        </label>

        <div data-accordion-body
          class="sidebar__navigation__list no-js-accordion"
          id="accordion-{{ block.id }}"
          {% if accordion_open_boolean == false %} style="display: none;" {% endif %}>
          {{ links_html }}
        </div>

        {% if linklists[custom_nav_list].links.size > 10 %}
          <button type="button" data-show-more>{{ 'collections.sidebar.show_more' | t }}</button>
        {% endif %}
      </div>

      {% for link in linklists[custom_nav_list].links %}
        {%- liquid
          # Reset logic for inner loop
          assign accordion_initial_state = 'accordion-is-open'
          assign accordion_open_boolean = true
          if section.settings.collapse_filters
            assign accordion_initial_state = ''
            assign accordion_open_boolean = false
          endif
        -%}
        {%- assign accordion_unique = link.title | handle | append: '-' | append: block.id | append: '-' | append: forloop.index -%}

        {% if link.links != blank %}
          {%- capture links_html -%}
            {% for childlink in link.links %}
              <div class="sidebar__item{% if childlink.active %} sidebar__item--active{% endif %} stateful-filter-icons{% if forloop.index > 10 %} is-hidden{% endif %}">
                <a href="{{ childlink.url }}">{{ childlink.title | escape }}</a>
                {% render 'icon-stateful-box' %}
              </div>

              {%- if childlink.active -%}
                {%- assign accordion_initial_state = 'accordion-is-open' -%}
                {%- assign accordion_open_boolean = true -%}
              {%- endif -%}
            {% endfor %}
          {%- endcapture -%}

          <div class="sidebar__filter__group">
            <button class="sidebar__heading js {{ accordion_initial_state }}"
              data-accordion-trigger="accordion-{{ accordion_unique }}"
              aria-controls="accordion-{{ accordion_unique }}"
              aria-haspopup="true"
              aria-expanded="{{ accordion_open_boolean }}"
              >
              <span>{{ link.title }}</span>

              <span class="sidebar__heading-chevron">
                {% render 'icon-core-chevron-right' %}
                <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
                <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
              </span>
            </button>

            {% if linklists[custom_nav_list].levels == 1 %}
              <input type="checkbox"
                class="no-js-checkbox"
                name="accordion-{{ accordion_unique }}"
                id="accordion-{{ accordion_unique }}-checkbox"
                class="no-js no-js-checkbox" checked>

              <label for="accordion-{{ accordion_unique }}-checkbox">
                <span>{{ link.title }}</span>

                <span class="sidebar__heading-chevron">
                  {% render 'icon-core-chevron-right' %}
                  <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
                  <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
                </span>
              </label>
            {% endif %}

            <div data-accordion-body
              class="sidebar__navigation__list no-js-accordion"
              id="accordion-{{ accordion_unique }}"
              {% if accordion_open_boolean == false %} style="display: none;" {% endif %}>
              {{ links_html }}
            </div>

            {% if link.links.size > 10 %}
              <button type="button" data-show-more>{{ 'collections.sidebar.show_more' | t }}</button>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endunless %}

  {%- when 'collections' -%}
    <div class="hidden md:block">
      {% if collections.size > 1 %}
        {%- capture links_html -%}
          {% for collection_link in collections %}
            {%- assign skip_collection = false -%}

            {%- for exclude in excluded_collections_strict -%}
              {%- assign exclude_handle = exclude | handle -%}

              {%- if exclude_handle == collection_link.handle -%}
                {%- assign skip_collection = true -%}
              {%- endif -%}
            {%- endfor -%}

            {%- for exclude in excluded_collections -%}
              {%- assign exclude_handle = exclude | handle -%}

              {%- if collection_link.handle contains exclude_handle -%}
                {%- assign skip_collection = true -%}
              {%- endif -%}
            {%- endfor -%}

            {% unless skip_collection %}
              <div class="sidebar__item{% if collection.handle == collection_link.handle %} sidebar__item--active{% endif %} stateful-filter-icons{% if forloop.index > 10 %} is-hidden{% endif %}">
                <a href="{{ routes.collections_url }}/{{ collection_link.handle }}">{{ collection_link.title }}</a>
                {% render 'icon-stateful-box' %}
              </div>
            {% endunless %}

            {%- if collection.handle == collection_link.handle -%}
              {%- assign accordion_initial_state = 'accordion-is-open' -%}
              {%- assign accordion_open_boolean = true -%}
            {%- endif -%}
          {% endfor %}
        {%- endcapture -%}

        <div class="sidebar__filter__group" {{ block.shopify_attributes }}>
          <button class="sidebar__heading js {{ accordion_initial_state }}"
            data-accordion-trigger="accordion-{{ block.id }}"
            aria-controls="accordion-{{ block.id }}"
            aria-haspopup="true"
            aria-expanded="{{ accordion_open_boolean }}">

            <span>{{ block.settings.title }}</span>

            <span class="sidebar__heading-chevron">
              {% render 'icon-core-chevron-right' %}
              <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
              <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
            </span>
          </button>

          <input type="checkbox"
            name="accordion-{{ block.id }}"
            id="accordion-{{ block.id }}-checkbox"
            class="no-js no-js-checkbox" checked>

          <label for="accordion-{{ block.id }}-checkbox" class="sidebar__heading no-js">
            <span>{{ block.settings.title }}</span>

            <span class="sidebar__heading-chevron">
              {% render 'icon-core-chevron-right' %}
              <span class="a11y__show visually-hidden">{{ 'general.accessibility.expand_menu' | t }}</span>
              <span class="a11y__hide visually-hidden">{{ 'general.accessibility.hide_menu' | t }}</span>
            </span>
          </label>

          <div data-accordion-body
            class="sidebar__navigation__list no-js-accordion"
            id="accordion-{{ block.id }}"
            {% if accordion_open_boolean == false %} style="display: none;" {% endif %}>
            {{ links_html }}
          </div>

          {% if collections.size > 10 %}
            <button type="button" data-show-more>{{ 'collections.sidebar.show_more' | t }}</button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {%- endcase -%}
{%- endfor -%}





